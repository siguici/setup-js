name: Setup Environment

description: |
  This action sets up the runtime, installs dependencies, and runs tests for Node.js, Deno, or Bun.

inputs:
  runtime:
    description: 'The runtime to use (node, deno, or bun)'
    required: true
    type: string
  version:
    description: 'The version of the runtime'
    required: true
    type: string
  pm:
    description: 'Package manager to use (npm, yarn, pnpm)'
    required: false
    type: string

runs:
  using: 'composite'
  steps:
    - name: ğŸšš Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ³ Set up Node.js
      if: ${{ inputs.runtime == 'node' }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ inputs.version }}

    - name: ğŸ¦• Set up Deno
      if: ${{ inputs.runtime == 'deno' }}
      uses: denoland/setup-deno@v2
      with:
        deno-version: ${{ inputs.version }}

    - name: ğŸ Set up Bun
      if: ${{ inputs.runtime == 'bun' }}
      uses: oven-sh/setup-bun@v2
      with:
        bun-version: ${{ inputs.version }}

    - name: ğŸ“¦ Install dependencies
      run: |
        case "${{ inputs.runtime }}" in
          "node")
            echo "âš™ï¸ Installing ${{ inputs.pm }} dependencies"
            corepack enable
            if [[ "${{ inputs.pm }}" == "yarn" ]]; then
              YARN_VERSION=$(yarn --version)
              jq ".packageManager = \"yarn@$YARN_VERSION\"" package.json > yarn-package.json
              mv package.json main-package.json
              mv yarn-package.json package.json
            fi
            corepack prepare ${{ inputs.pm }}@latest --activate
            if [[ "${{ inputs.pm }}" == "npm" ]]; then
              npm install --legacy-peer-deps
            else
              ${{ inputs.pm }} install
            fi
            ;;
          "deno")
            echo "âš™ï¸ Installing Deno dependencies"
            deno install
            ;;
          "bun")
            echo "âš™ï¸ Installing Bun dependencies"
            bun install
            ;;
          *)
            echo "âŒ Invalid runtime specified: ${{ inputs.runtime }}"
            exit 1
            ;;
        esac
      shell: bash

    - name: ğŸ§ª Run tests
      run: |
        case "${{ inputs.runtime }}" in
          "node")
            echo "âœ… Running tests with ${{ inputs.pm }}"
            ${{ inputs.pm }} run test
            ;;
          "deno")
            echo "âœ… Running tests with Deno"
            deno task test
            ;;
          "bun")
            echo "âœ… Running tests with Bun"
            bun run test
            ;;
          *)
            echo "âŒ Invalid runtime specified: ${{ inputs.runtime }}"
            exit 1
            ;;
        esac
      shell: bash

    - name: ğŸ‰ Finish test workflow
      run: echo "ğŸ¯ Tests completed for ${{ inputs.runtime }} ${{ inputs.version }}!"
      shell: bash
